<?php
declare(strict_types = 1);

namespace {{ projectName }}\Domain\Service\{{ entityName }}\Manager;

use Sfynx\DddBundle\Layer\Domain\Service\Generalisation\Factory\RepositoryFactoryInterface;
use Sfynx\DddBundle\Layer\Domain\Service\Generalisation\Manager\{
    AbstractManager,
    TraitDeleteMany,
    TraitDeleteOne,
    TraitGetAll,
    TraitGetByIds,
    TraitGetOne,
    TraitSearchBy
};
use Sfynx\DddBundle\Layer\Domain\Generalisation\Processor\{
    ProcessorInterface,
    TraitProcessor
};
use Sfynx\DddBundle\Layer\Infrastructure\Logger\Generalisation\TraitLogger;
use {{ projectName }}\Domain\Entity\{{ entityName }};

/**
 * Class {{ entityName }}Manager.
 *
 * @category {{ projectName }}
 * @package Domain
 * @subpackage Service\Manager
 */
class {{ entityName }}Manager extends AbstractManager implements ProcessorInterface
{
    use TraitProcessor;
    use TraitLogger;
    use TraitGetAll;
    use TraitGetOne;
    use TraitGetByIds;
    use TraitDeleteOne;
    use TraitDeleteMany;
    use TraitSearchBy;

    /**
     * Hydrate the entity then call the New Repository.
{% for field in entityFields %}     * @param {% if field.type == "id" %}{% if field.voName is defined %}{{ field.voName }}{% else %}int{% endif %}{% else %}string{% endif %} ${{ field.name }}
{% endfor %}
     * @return {{ entityName }}
     */
    public function create({{ constructorArgs }}): {{ entityName }}
    {
        //hydrate with VO
        $entity = {{ entityName }}::makeInstance(
            $_SERVER['HTTP_X_TENANT_ID'],
            {{ paramsString|replace({'!#MARKER#!': "\n" ~ '            '}) }}
        );

        //execute prepersist processor
        $this->executeProcess('prepersist_create', $entity);

        // Persistence handler
        $object = new \stdClass();
        $object->entity = $entity;
        $this->factory->buildRepository(RepositoryFactoryInterface::NEW_REPOSITORY)->execute($object);

        //execute postpersist processor
        $this->executeProcess('postpersist_create', $entity);

        // Log handler
        $this->logger->info('{{ entityName }} ' . $entity->getId() . ' has been saved.', ['{{ entityName|lower }}' => $entity]);

        return $entity;
    }

    /**
     * Get the current entity, hydrate it with updated values and call the Update Repository.
{% for field in entityFields %}     * @param {% if field.type == "id" %}{% if field.voName is defined %}{{ field.voName }}{% else %}int{% endif %}{% elseif field.type == "idVO" %}string{% else %}{{ field.type }}{% endif %} ${{ field.name }}
{% endfor %}
     * @return {{ entityName }}
     */
    public function update({{ constructorArgs }}): {{ entityName }}
    {
        //get {{ entityName }} by id
        $object = new \stdClass();
{% for field in entityFields %}
{% if field.type == "id" %}
        $object->entityId = ${{ field.name }}->id();

        /** @var $entity {{ entityName }} */
        $entity = $this->factory->buildRepository(RepositoryFactoryInterface::ONE_REPOSITORY)->execute($object);
{% endif %}
{% endfor %}

        //todo: manage exception if entity is null.
        //if (null === $entity) {
        //}

        //hydrate with VO
{% for field in entityFields %}
{% if field.type == "id" or field.type == "idVO" %}
        $entity->set{{ field.type|ucfirst }}(${{ field.name }});
{% else %}
{% if field.type == "valueObject" %}
{% if valueObjects[field.voName]["name"] == field.voName %}
{% set namespace = valueObjects[field.voName]["type"]|split('\\') %}
{% set key = namespace|length - 1 %}
{% set namespace = namespace[key] %}
{% else %}
{% set namespace = "" %}
{% endif %}
{% else %}
{% set namespace = "" %}
{% endif %}
        $entity->set{{ field.name|ucfirst }}(${{ field.name }});
{% endif %}
{% endfor %}

        //execute prepersist processor
        $this->executeProcess('prepersist_update', $entity);

        // Persistance handler
        $object->entity = $entity;
        $this->factory->buildRepository(RepositoryFactoryInterface::UPDATE_REPOSITORY)->execute($object);

        //execute postpersist processor
        $this->executeProcess('postpersist_update', $entity);

        // Log handler
        $this->logger->info('{{ entityName }} ' . $entity->getId() . ' has been saved.', ['{{ entityName|lower }}' => $entity]);

        return $entity;
    }
}
