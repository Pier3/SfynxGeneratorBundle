<?php
declare(strict_types = 1);

namespace {{ projectName }}\Domain\Workflow\{{ entityName }}\Listener;

use Sfynx\DddBundle\Layer\Domain\Generalisation\Observer\ObservableInterface;
use Sfynx\DddBundle\Layer\Domain\Generalisation\Observer\ObserverInterface;
use {{ projectName }}\Application\{{ entityName }}\Command\UpdateCommand;
use {{ projectName }}\Application\{{ entityName }}\Command\PatchCommand;
{% for data in valueObjects %}
//use {{ projectName }}\Domain\ValueObject\{{ data.name }}; //todo: create the value object through the generator.
{% endfor %}
{% for field in entityFields %}
{% if field.type == "id" and field.voName is defined %}
use Sfynx\DddBundle\Layer\Domain\ValueObject\{{ field.voName }};
{% endif %}
{% endfor %}
use Sfynx\DddBundle\Layer\Infrastructure\Exception\DomainException;

/**
 * Class WFGenerateVOListener
 *
 * @category {{ projectName }}
 * @package Domain
 * @subpackage Workflow\Listener
 *
 */
class WFGenerateVOListener implements ObserverInterface
{
    /**
     * @param ObservableInterface $wfHandler
     * @throws DomainException
     */
    public function update(ObservableInterface $wfHandler)
    {
{% if entityFields is empty %}

{% else %}
        $this{% for field in entityFields %}->set{{ field.name|capitalize }}($wfHandler){% if loop.index < entityFields|length %}

            {% else %};
{% endif %}{% endfor %}
{% endif %}
    }
{% for field in entityFields %}

    /**
     * @param ObservableInterface $wfHandler
     * @return $this
     */
    public function set{{ field.name|capitalize }}(ObservableInterface $wfHandler)
    {
{% if field.type=="id" %}
        if ($wfHandler->getCommand() instanceof UpdateCommand || $wfHandler->getCommand() instanceof PatchCommand) {
{% if field.voName is defined %}
            $wfHandler->data->{{ field.name }}[] = new {{ field.voName }}($wfHandler->getCommand()->get{{ field.name|ucfirst }}());
{% else %}
            $wfHandler->data->{{ field.name }}[] = $wfHandler->getCommand()->get{{ field.name|ucfirst }}();
{% endif %}
        }
{% elseif field.type == "valueObject" %}
{% set parameters = "" %}
{% for name, data in valueObjects %}
{% if name == field.voName %}
{% for vofield in data.fields %}
{% set parameters = parameters ~ "$wfHandler->getCommand()->get" ~ field.name|ucfirst ~"()['"~ vofield.name ~"'], " %}
{% endfor %}
{% endif %}
{% endfor %}
        $wfHandler->data->{{ field.name }}[] = new {{ field.voName }}({{ parameters|trim(', ') }});
{% else %}
        $wfHandler->data->{{ field.name }}[] = $wfHandler->getCommand()->get{{ field.name|ucfirst }}();
{% endif %}
        return $this;
    }
{% endfor %}
}
